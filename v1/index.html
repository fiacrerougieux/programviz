<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competencies Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        #controls {
            margin-bottom: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 30px;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            width: fit-content;
            min-width: 200px;
        }
        #plot-container {
            width: 100%;
            height: 1000px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .section-title {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #333;
        }
        .switch-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            margin: 0 5px;
            transition: background-color 0.3s;
        }
        .switch-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .switch-button:not(.active) {
            background-color: #f0f0f0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="controls">
            <div class="button-group">
                <h3 class="section-title">Competencies</h3>
                <button id="radarBtn" class="switch-button">What to scaffold?</button>
                <button id="heatmapCumBtn" class="switch-button">When to scaffold?</button>
                <button id="heatmapNonCumBtn" class="switch-button active">Where to scaffold?</button>
            </div>
        </div>
        <div id="plot-container"></div>
    </div>

    <script>
        const competencies = {
            "1.1": "Science Fundamentals",
            "1.2": "Math Foundations",
            "1.3": "Specialist Knowledge",
            "1.4": "Research Directions",
            "1.5": "Design Practice",
            "1.6": "Sustainable Practice",
            "2.1": "Problem Solving",
            "2.2": "Tech Application",
            "2.3": "Design Processes",
            "2.4": "Project Management",
            "3.1": "Ethical Conduct",
            "3.2": "Effective Communication",
            "3.3": "Creative Mindset",
            "3.4": "Info Management",
            "3.5": "Self Management",
            "3.6": "Team Leadership"
        };

        let percentage_matrix;
        let cumulative_percentage_matrix;
        let x_labels;
        let combined_competency_labels;
        let shapes;
        let annotations;
        let filtered_courses;

        fetch('competencies_SPREE.json')
            .then(response => response.json())
            .then(course_competencies => {
                fetch('bachelor_RE_RE_Systems_Strand.json')
                    .then(response => response.json())
                    .then(course_schedule => {
                        processData(course_competencies, course_schedule);
                        createHeatmap(false);
                    });
            });

        function processData(course_competencies, course_schedule) {
            const courses = [];
            Object.keys(course_schedule).sort().forEach(year => {
                Object.keys(course_schedule[year]).sort().forEach(term => {
                    courses.push(...course_schedule[year][term]);
                });
            });

            const unwanted_courses = new Set(["DISP", "GEN ED", "ELECTIVE", "ELEC3115", "ELEC4122"]);
            filtered_courses = courses.filter(course => !unwanted_courses.has(course));

            const detailed_competency_ids = Object.keys(competencies).filter(comp_id => comp_id.includes('.'));
            const matrix = Array(detailed_competency_ids.length).fill().map(() => Array(filtered_courses.length).fill(0));

            Object.entries(course_competencies).forEach(([comp_id, sub_comps]) => {
                Object.entries(sub_comps).forEach(([sub_comp, courses_dict]) => {
                    if (detailed_competency_ids.includes(sub_comp)) {
                        Object.entries(courses_dict).forEach(([course, clos]) => {
                            if (filtered_courses.includes(course)) {
                                const row_index = detailed_competency_ids.indexOf(sub_comp);
                                const col_index = filtered_courses.indexOf(course);
                                matrix[row_index][col_index] += clos.length;
                            }
                        });
                    }
                });
            });

            const total_clos_per_course = matrix.reduce((acc, row) => {
                row.forEach((val, i) => acc[i] = (acc[i] || 0) + val);
                return acc;
            }, []);

            percentage_matrix = matrix.map(row => 
                row.map((val, i) => total_clos_per_course[i] ? (val / total_clos_per_course[i]) * 100 : 0)
            );

            cumulative_percentage_matrix = percentage_matrix.map(row => {
                let sum = 0;
                return row.map(val => {
                    sum += val;
                    return Math.min(sum, 100);
                });
            });

            shapes = [];
            annotations = [];
            const bar_courses = ["ELEC1111", "MATH2069", "ELEC2911"];
            const years = ["Year 1", "Year 2", "Year 3", "Year 4"];

            const bar_positions = [];
            bar_courses.forEach(bar_course => {
                if (filtered_courses.includes(bar_course)) {
                    const idx = filtered_courses.indexOf(bar_course);
                    bar_positions.push(idx + 0.5);
                    shapes.push({
                        type: "line",
                        x0: idx + 0.5,
                        y0: -0.5,
                        x1: idx + 0.5,
                        y1: detailed_competency_ids.length - 0.5,
                        line: { color: "black", width: 2 }
                    });
                }
            });

            const all_positions = [-0.5, ...bar_positions, filtered_courses.length - 0.5];
            years.forEach((year, i) => {
                annotations.push({
                    x: (all_positions[i] + all_positions[i + 1]) / 2,
                    y: 1.05,
                    yref: "paper",
                    text: year,
                    showarrow: false,
                    font: { size: 18, color: "black" }
                });
            });

            combined_competency_labels = detailed_competency_ids.map(comp_id => 
                `${comp_id} - ${competencies[comp_id]}`
            );

            const category_counters = {
                Math: 0,
                Physics: 0,
                Specialisation: 0,
                Design: 0,
                Other: 0
            };

            x_labels = filtered_courses.map(course => {
                let category = "Other";
                if (course.startsWith("MATH")) category = "Math";
                else if (course.startsWith("PHYS")) category = "Physics";
                else if (course.startsWith("ENGG") || course.startsWith("SOLA") || 
                         course.startsWith("MMAN") || course.startsWith("ELEC")) category = "Specialisation";
                else if (course.startsWith("DESN")) category = "Design";
                
                category_counters[category]++;
                return `${category} (${category_counters[category]})`;
            });
        }

        function createHeatmap(isCumulative) {
            const data = [{
                type: "heatmap",
                z: isCumulative ? cumulative_percentage_matrix : percentage_matrix,
                x: x_labels,
                y: combined_competency_labels,
                colorscale: 'YlOrRd',
                reversescale: true,
                zmin: 0,
                zmax: isCumulative ? 100 : 100,
                colorbar: { 
                    title: isCumulative ? "Cumulative CLOs (%)" : "Percentage of CLOs",
                    titlefont: { size: 16 },
                    tickfont: { size: 14 }
                }
            }];

            const layout = {
                xaxis: {
                    title: "Courses",
                    titlefont: { size: 18 },
                    tickmode: 'array',
                    tickvals: Array.from({length: x_labels.length}, (_, i) => i),
                    ticktext: x_labels,
                    tickangle: 45,
                    tickfont: { size: 14 }
                },
                yaxis: {
                    title: "Competencies",
                    titlefont: { size: 18 },
                    tickmode: 'array',
                    tickvals: Array.from({length: combined_competency_labels.length}, (_, i) => i),
                    ticktext: combined_competency_labels,
                    tickfont: { size: 14 }
                },
                height: 1000,
                shapes: shapes,
                annotations: annotations,
                margin: {
                    l: 200,
                    r: 50,
                    t: 50,
                    b: 100
                }
            };

            Plotly.newPlot('plot-container', data, layout);
        }

        function createRadarPlot() {
            const bar_courses = ["ELEC1111", "MATH2069", "ELEC2911", "SOLA4953"].reverse();
            const course_labels = ["Year 1", "Year 2", "Year 3", "Year 4"].reverse();
            const colors = [
                'rgba(254, 204, 92, 0.30)',
                'rgba(253, 141, 60, 0.25)',
                'rgba(240, 59, 32, 0.20)',
                'rgba(189, 0, 38, 0.15)'
            ];

            const radar_data = [];
            for (let i = 0; i < bar_courses.length; i++) {
                const course = bar_courses[i];
                if (filtered_courses.includes(course)) {
                    const idx = filtered_courses.indexOf(course);
                    const r_values = [...cumulative_percentage_matrix.map(row => row[idx])];
                    r_values.push(r_values[0]); // Close the loop
                    const theta_values = [...combined_competency_labels, combined_competency_labels[0]];

                    radar_data.push({
                        type: 'scatterpolar',
                        r: r_values,
                        theta: theta_values,
                        fill: 'toself',
                        fillcolor: colors[i],
                        name: course_labels[i],
                        line: {
                            shape: 'spline',
                            color: colors[i].replace(/[0-9.]+\)$/, '1.0)')
                        }
                    });
                }
            }

            const layout = {
                polar: {
                    radialaxis: {
                        visible: true,
                        range: [0, 100],
                        tickvals: [0, 25, 50, 75, 100],
                        ticktext: ['0%', '25%', '50%', '75%', '100%'],
                        tickfont: { size: 12 },
                        gridcolor: 'lightgrey',
                        linecolor: 'grey'
                    },
                    angularaxis: {
                        tickfont: { size: 12 },
                        gridcolor: 'lightgrey',
                        linecolor: 'grey'
                    },
                    bgcolor: 'white'
                },
                showlegend: true,
                legend: {
                    font: { size: 12, family: 'Arial, sans-serif' },
                    bgcolor: 'white',
                    bordercolor: 'white',
                    borderwidth: 0,
                    x: 1.1,
                    y: 1,
                    xanchor: 'left',
                    yanchor: 'top'
                },
                width: 1100,
                height: 800
            };

            Plotly.newPlot('plot-container', radar_data, layout);
        }

        document.getElementById('heatmapNonCumBtn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('heatmapCumBtn').classList.remove('active');
            document.getElementById('radarBtn').classList.remove('active');
            createHeatmap(false);
        });

        document.getElementById('heatmapCumBtn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('heatmapNonCumBtn').classList.remove('active');
            document.getElementById('radarBtn').classList.remove('active');
            createHeatmap(true);
        });

        document.getElementById('radarBtn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('heatmapNonCumBtn').classList.remove('active');
            document.getElementById('heatmapCumBtn').classList.remove('active');
            createRadarPlot();
        });
    </script>
</body>
</html>
